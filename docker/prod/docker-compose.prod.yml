version: "3.8"

# Production configuration for custom Studio build
# Usage: docker compose -f docker-compose.yml -f ./prod/docker-compose.prod.yml up
#
# Runtime Configuration:
# =====================
# This configuration uses runtime environment variables instead of build-time variables.
# This allows the same Docker image to be deployed to multiple environments without rebuilding.
#
# Required Environment Variables:
# - SUPABASE_PUBLIC_URL: Public-facing URL for the Supabase API (e.g., http://47.96.6.236:8000)
# - API_EXTERNAL_URL: External API gateway URL (e.g., http://47.96.6.236:8000)
# - ANON_KEY: Anonymous API key for authentication
#
# The Studio frontend will fetch configuration from /api/runtime-config at startup,
# which reads these environment variables and provides them to the client.

services:
  studio:
    # Override the official image with custom build
    image: supabase/studio:latest  # Custom image tag
    build:
      context: ..                   # Project root (docker/..)
      dockerfile: apps/studio/Dockerfile
      target: production            # Use production target
      args:
        # Requirements 1.1, 1.3: Proper build-time environment variable passing
        # Production builds require explicit ENVIRONMENT=production
        - ENVIRONMENT=production
        - NODE_ENV=production
        - NEXT_PUBLIC_REQUIRE_LOGIN=true
        - NEXT_PUBLIC_IS_PLATFORM=false
    # Production environment variables - runtime configuration
    environment:
      # Runtime Configuration Variables
      # These are read by /api/runtime-config at application startup
      SUPABASE_PUBLIC_URL: ${SUPABASE_PUBLIC_URL}
      API_EXTERNAL_URL: ${API_EXTERNAL_URL}
      SUPABASE_URL: http://kong:8000
      
      # Authentication keys
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_ANON_KEY: ${ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SERVICE_ROLE_KEY}
      AUTH_JWT_SECRET: ${JWT_SECRET}
      
      # Service URLs (internal Docker network)
      STUDIO_PG_META_URL: http://meta:8080
      
      # Database configuration
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
